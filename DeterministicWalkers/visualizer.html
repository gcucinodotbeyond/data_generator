<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dataset Visualizer</title>
    <style>
        :root {
            --bg-color: #0f172a;
            --sidebar-bg: #1e293b;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --accent-color: #3b82f6;
            --user-msg-bg: #3b82f6;
            --assistant-msg-bg: #334155;
            --tool-msg-bg: #475569;
            --border-color: #334155;
            --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* Sidebar */
        .sidebar {
            width: 300px;
            background-color: var(--sidebar-bg);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }

        .sidebar-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
        }

        .title {
            font-size: 1.25rem;
            font-weight: 700;
            margin: 0;
            background: linear-gradient(to right, #60a5fa, #a78bfa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .upload-section {
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .upload-btn {
            background-color: rgba(59, 130, 246, 0.1);
            color: var(--accent-color);
            border: 1px solid var(--accent-color);
            padding: 0.75rem;
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            text-align: center;
            transition: all 0.2s;
        }

        .upload-btn:hover {
            background-color: var(--accent-color);
            color: white;
        }

        .drop-zone {
            padding: 1.5rem;
            border: 2px dashed var(--border-color);
            border-radius: 0.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        .drop-zone:hover {
            border-color: var(--accent-color);
            color: var(--text-primary);
        }

        .drop-zone.active {
            border-color: var(--accent-color);
            background-color: rgba(59, 130, 246, 0.1);
        }

        .conversation-list {
            flex: 1;
            overflow-y: auto;
            padding: 0.5rem;
        }

        .file-group {
            margin-bottom: 1rem;
        }

        .file-header {
            padding: 0.5rem 1rem;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-secondary);
            background-color: rgba(0, 0, 0, 0.2);
            font-weight: 700;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
        }

        .conversation-item {
            padding: 0.75rem 1rem;
            margin: 0.25rem 0.5rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s;
            border: 1px solid transparent;
        }

        .conversation-item:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }

        .conversation-item.active {
            background-color: rgba(59, 130, 246, 0.2);
            border-color: var(--accent-color);
        }

        .item-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.25rem;
        }

        .item-scenario {
            font-weight: 600;
            font-size: 0.9rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .item-id {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background-color: var(--bg-color);
        }

        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 2rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .message {
            max-width: 80%;
            padding: 1rem;
            border-radius: 1rem;
            line-height: 1.5;
            position: relative;
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message-header {
            font-size: 0.75rem;
            margin-bottom: 0.5rem;
            opacity: 0.8;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .message-content {
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        /* User Message */
        .user {
            align-self: flex-end;
            background-color: var(--user-msg-bg);
            border-bottom-right-radius: 0.2rem;
        }

        /* Assistant Message */
        .assistant {
            align-self: flex-start;
            background-color: var(--assistant-msg-bg);
            border-bottom-left-radius: 0.2rem;
        }

        /* System Message */
        .system {
            align-self: center;
            background-color: rgba(255, 255, 255, 0.05);
            max-width: 90%;
            font-size: 0.9rem;
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
        }

        /* Tool Message */
        .tool {
            align-self: flex-start;
            background-color: var(--tool-msg-bg);
            font-family: 'Fira Code', monospace;
            font-size: 0.9rem;
            border-left: 4px solid #10b981;
        }

        /* Function Call */
        .function-call {
            background-color: #2e1065;
            border: 1px solid #8b5cf6;
            margin-top: 0.5rem;
            padding: 0.75rem;
            border-radius: 0.5rem;
            font-family: 'Fira Code', monospace;
            font-size: 0.85rem;
        }

        /* Metadata Panel */
        .metadata-panel {
            width: 300px;
            background-color: var(--sidebar-bg);
            border-left: 1px solid var(--border-color);
            padding: 1.5rem;
            overflow-y: auto;
        }

        .meta-section {
            margin-bottom: 2rem;
        }

        .meta-title {
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-secondary);
            margin-bottom: 1rem;
            font-weight: 700;
        }

        .json-block {
            background-color: rgba(0, 0, 0, 0.3);
            padding: 1rem;
            border-radius: 0.5rem;
            font-family: 'Fira Code', monospace;
            font-size: 0.8rem;
            white-space: pre-wrap;
            color: #d1d5db;
        }

        .empty-state {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-secondary);
            flex-direction: column;
            gap: 1rem;
        }

        .badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            background-color: rgba(255, 255, 255, 0.1);
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }
    </style>
</head>

<body>

    <!-- Sidebar for Files/Conversations -->
    <div class="sidebar">
        <div class="sidebar-header">
            <h1 class="title">Dataset Visualizer</h1>
        </div>

        <div class="upload-section">
            <div id="folderBtn" class="upload-btn">üìÇ Select Data Folder</div>
            <div id="dropZone" class="drop-zone">
                or drop files here
            </div>
            <input type="file" id="fileInput" accept=".jsonl,.json" style="display: none;" multiple>
            <input type="file" id="folderInput" webkitdirectory directory style="display: none;">
        </div>

        <div id="conversationList" class="conversation-list">
            <!-- List items will be injected here -->
        </div>
    </div>

    <!-- Main Chat Area -->
    <div class="main-content">
        <div id="chatContainer" class="chat-container">
            <div class="empty-state">
                <div style="font-size: 3rem;">üëã</div>
                <h2>Select a conversation to view</h2>
                <p>Load the <code>DeterministicWalkers/data</code> folder to start</p>
                <p style="font-size: 0.8rem; color: #64748b;">(Or if visualizer_data.js is present, data is preloaded)</p>
            </div>
        </div>
    </div>

    <!-- Right Metadata Panel -->
    <div class="metadata-panel" id="metadataPanel" style="display: none;">
        <div class="meta-section">
            <div class="meta-title">Metadata</div>
            <div id="metaContent" class="json-block"></div>
        </div>
        <div class="meta-section">
            <div class="meta-title">Contexts</div>
            <div id="contextContent" class="json-block"></div>
        </div>
    </div>

    <script>
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const folderInput = document.getElementById('folderInput');
        const folderBtn = document.getElementById('folderBtn');
        const conversationList = document.getElementById('conversationList');
        const chatContainer = document.getElementById('chatContainer');
        const metadataPanel = document.getElementById('metadataPanel');
        const metaContent = document.getElementById('metaContent');
        const contextContent = document.getElementById('contextContent');

        // State
        let allFilesData = {}; // filename -> [conversations]

        // Drag & Drop Handlers
        dropZone.addEventListener('click', () => fileInput.click());
        folderBtn.addEventListener('click', () => folderInput.click());

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('active');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('active');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('active');
            handleFiles(e.dataTransfer.files);
        });

        fileInput.addEventListener('change', (e) => {
            handleFiles(e.target.files);
        });

        folderInput.addEventListener('change', (e) => {
            handleFiles(e.target.files);
        });

        // Initialize when window loads
        window.onload = function() {
             if (window.PRELOADED_DATA) {
                console.log("Found preloaded data!");
                allFilesData = window.PRELOADED_DATA;
                renderSidebar();
                
                // Automatically select the first file
                const firstFile = Object.keys(allFilesData).sort()[0];
                 if (firstFile && allFilesData[firstFile].length > 0) {
                     // We could auto-select, but let's just make sure sidebar is populated
                 }
            } else {
                 console.log("No preloaded data found.");
            }
        };

        function handleFiles(fileList) {
            Array.from(fileList).forEach(file => {
                if (file.name.endsWith('.jsonl') || file.name.endsWith('.json')) {
                    readFile(file);
                }
            });
        }

        function readFile(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const text = e.target.result;
                const conversations = parseJSONL(text);
                if (conversations.length > 0) {
                    allFilesData[file.name] = conversations;
                    renderSidebar();
                }
            };
            reader.readAsText(file);
        }

        function parseJSONL(text) {
            const lines = text.trim().split('\n');
            const parsed = [];
            lines.forEach((line, index) => {
                try {
                    if (!line.trim()) return;
                    const cleanLine = line.replace(/^\d+:\s*/, '');
                    parsed.push(JSON.parse(cleanLine));
                } catch (e) {
                    console.error(`Error parsing line ${index}:`, e);
                }
            });
            return parsed;
        }

        function renderSidebar() {
            conversationList.innerHTML = '';

            Object.keys(allFilesData).sort().forEach(filename => {
                const fileGroup = document.createElement('div');
                fileGroup.className = 'file-group';

                const header = document.createElement('div');
                header.className = 'file-header';
                header.innerHTML = `<span>${filename}</span> <span>${allFilesData[filename].length}</span>`;

                // Toggle visibility logic could go here

                fileGroup.appendChild(header);

                allFilesData[filename].forEach((conv, index) => {
                    const el = document.createElement('div');
                    el.className = 'conversation-item';

                    const meta = conv._meta || {};
                    const scenario = meta.scenario || filename.replace('.jsonl', '');
                    const runId = meta.run_id !== undefined ? `Run #${meta.run_id}` : `ID #${index}`;

                    el.innerHTML = `
                        <div class="item-row">
                            <span class="item-scenario">${scenario}</span>
                            <span class="badge" style="font-size:0.6rem;">${conv.messages.length} msgs</span>
                        </div>
                        <div class="item-id">${runId}</div>
                    `;

                    el.addEventListener('click', () => {
                        // clear active class from all
                        document.querySelectorAll('.conversation-item').forEach(i => i.classList.remove('active'));
                        el.classList.add('active');
                        renderChat(conv);
                        renderMetadata(conv);
                    });
                    fileGroup.appendChild(el);
                });

                conversationList.appendChild(fileGroup);
            });
        }

        function renderChat(conv) {
            chatContainer.innerHTML = '';

            conv.messages.forEach(msg => {
                const wrapper = document.createElement('div');
                wrapper.className = `message ${msg.role}`;

                let header = `<div class="message-header">${msg.role}</div>`;
                let content = '';

                // Handle text content
                if (msg.content) {
                    if (typeof msg.content === 'string' && (msg.content.startsWith('{') || msg.content.startsWith('['))) {
                        try {
                            const pretty = JSON.stringify(JSON.parse(msg.content), null, 2);
                            content += `<div class="json-block">${escapeHtml(pretty)}</div>`;
                        } catch {
                            content += `<div class="message-content">${escapeHtml(msg.content)}</div>`;
                        }
                    } else {
                        content += `<div class="message-content">${escapeHtml(msg.content)}</div>`;
                    }
                }

                // Handle Tool Calls
                if (msg.tool_calls) {
                    content += msg.tool_calls.map(call => {
                        return `
                            <div class="function-call">
                                <div style="color: #c4b5fd; margin-bottom: 0.25rem;">üõ†Ô∏è ${escapeHtml(call.function.name)}</div>
                                <div style="color: #a78bfa;">${escapeHtml(call.function.arguments)}</div>
                            </div>
                        `;
                    }).join('');
                }

                wrapper.innerHTML = header + content;
                chatContainer.appendChild(wrapper);
            });
        }

        function renderMetadata(conv) {
            metadataPanel.style.display = 'block';

            const { _meta, ...rest } = conv;
            const { contexts, ...metaRest } = _meta || {};

            metaContent.textContent = _meta ? JSON.stringify(metaRest, null, 2) : "No metadata";
            contextContent.textContent = contexts ? JSON.stringify(contexts, null, 2) : "No context data";
        }

        function escapeHtml(text) {
            if (typeof text !== 'string') return text;
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }
    </script>
    <script src="visualizer_data.js"></script>
</body>

</html>